{% extends "layout.html" %}

{% block title %}{{ t('admin_panel') }} - {{ t('app_title') }}{% endblock %}

{% block content %}
<style>
    .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .admin-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .admin-header h1 {
        color: white;
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .admin-header .role-badge {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        color: white;
        font-weight: 600;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #7030A0;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: #666;
        font-size: 0.9rem;
    }

    .users-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .users-section h2 {
        color: #7030A0;
        margin-bottom: 1.5rem;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
    }

    .users-table th {
        background: #7030A0;
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
    }

    .users-table td {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .users-table tr:hover {
        background: #f8f5fc;
    }

    .role-badge-cell {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .role-super_admin {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: #333;
    }

    .role-director {
        background: linear-gradient(135deg, #7030A0 0%, #9b59d0 100%);
        color: white;
    }

    .role-methodist {
        background: linear-gradient(135deg, #2196F3 0%, #03A9F4 100%);
        color: white;
    }

    .role-teacher {
        background: #e0e0e0;
        color: #666;
    }

    .permission-note {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 8px;
    }

    .action-select {
        padding: 0.5rem;
        border-radius: 8px;
        border: 2px solid #7030A0;
        font-weight: 600;
        cursor: pointer;
        background: white;
        transition: all 0.3s ease;
    }

    .action-select:hover {
        border-color: #5a2680;
        background: #f8f5fc;
    }

    .delete-btn {
        padding: 0.5rem 1rem;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .delete-btn:hover {
        background: #da190b;
        transform: scale(1.05);
    }

    .delete-btn:active {
        transform: scale(0.95);
    }

    @media (max-width: 768px) {
        .admin-container {
            padding: 1rem;
        }

        .users-table {
            font-size: 0.85rem;
        }

        .users-table th,
        .users-table td {
            padding: 0.75rem 0.5rem;
        }
    }
</style>

<div class="admin-container">
    <div class="admin-header">
        <h1>
            {% if user.role == 'super_admin' %}
                üëë –°—É–ø–µ—Ä –ê–¥–º–∏–Ω
            {% elif user.role == 'director' %}
                üè¢ –î–∏—Ä–µ–∫—Ç–æ—Ä
            {% else %}
                ‚öôÔ∏è –ê–¥–º–∏–Ω
            {% endif %}
        </h1>
        <div class="role-badge">{{ t(user.role) }}</div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ all_users|length }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">
                {{ all_users|selectattr('role', 'equalto', 'teacher')|list|length }}
            </div>
            <div class="stat-label">–£—á–∏—Ç–µ–ª–µ–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">
                {{ all_users|selectattr('role', 'in', ['super_admin', 'director', 'methodist'])|list|length }}
            </div>
            <div class="stat-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</div>
        </div>
    </div>

    <div class="users-section">
        <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>

        {% if user.role == 'director' %}
        <div class="permission-note">
            <strong>‚ÑπÔ∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞:</strong>
            –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω—É.
        </div>
        {% endif %}

        <table class="users-table">
            <thead>
                <tr>
                    <th>–§–ò–û</th>
                    <th>Email</th>
                    <th>–®–∫–æ–ª–∞</th>
                    <th>–†–æ–ª—å</th>
                    <th>–ë–∞–ª–ª—ã</th>
                    {% if user.role == 'super_admin' %}
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for u in all_users %}
                <tr>
                    <td><strong>{{ u.full_name }}</strong></td>
                    <td>{{ u.username }}</td>
                    <td>{{ u.school }}</td>
                    <td>
                        <span class="role-badge-cell role-{{ u.role }}">
                            {% if u.role == 'super_admin' %}
                                üëë {{ t('super_admin') }}
                            {% elif u.role == 'director' %}
                                üè¢ {{ t('director') }}
                            {% elif u.role == 'methodist' %}
                                üìã {{ t('methodist') }}
                            {% else %}
                                üë®‚Äçüè´ {{ t('teacher') }}
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        {% set user_points = namespace(value=0) %}
                        {% for ach in u.achievements %}
                            {% set user_points.value = user_points.value + ach.points %}
                        {% endfor %}
                        <strong>{{ user_points.value }}</strong>
                    </td>
                    {% if user.role == 'super_admin' %}
                    <td>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            {% if u.id != user.id %}
                            <!-- –°–µ–ª–µ–∫—Ç –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏ -->
                            <select 
                                id="role-{{ u.id }}" 
                                onchange="changeRole({{ u.id }}, this.value)"
                                style="padding: 0.5rem; border-radius: 8px; border: 2px solid #7030A0; font-weight: 600; cursor: pointer;">
                                <option value="super_admin" {% if u.role == 'super_admin' %}selected{% endif %}>üëë –°—É–ø–µ—Ä –ê–¥–º–∏–Ω</option>
                                <option value="director" {% if u.role == 'director' %}selected{% endif %}>üè¢ –î–∏—Ä–µ–∫—Ç–æ—Ä</option>
                                <option value="methodist" {% if u.role == 'methodist' %}selected{% endif %}>üìã –ú–µ—Ç–æ–¥–∏—Å—Ç</option>
                                <option value="teacher" {% if u.role == 'teacher' %}selected{% endif %}>üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—å</option>
                            </select>
                            
                            <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                            <button 
                                onclick="deleteUser({{ u.id }}, '{{ u.full_name }}')"
                                style="padding: 0.5rem 1rem; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                            {% else %}
                            <span style="color: #999; font-style: italic;">–≠—Ç–æ –≤—ã</span>
                            {% endif %}
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if user.role == 'super_admin' %}
    <div class="users-section">
        <h2>üëë –§—É–Ω–∫—Ü–∏–∏ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω–∞</h2>
        <p>–ö–∞–∫ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω, –≤—ã –∏–º–µ–µ—Ç–µ –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å:</p>
        <ul>
            <li>‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
            <li>‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π</li>
            <li>‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
            <li>‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–æ–≤</li>
            <li>‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</li>
        </ul>
    </div>
    {% elif user.role == 'director' %}
    <div class="users-section">
        <h2>üè¢ –§—É–Ω–∫—Ü–∏–∏ –î–∏—Ä–µ–∫—Ç–æ—Ä–∞</h2>
        <p>–ö–∞–∫ –î–∏—Ä–µ–∫—Ç–æ—Ä, –≤—ã –∏–º–µ–µ—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∞:</p>
        <ul>
            <li>‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
            <li>‚ùå –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π (—Ç–æ–ª—å–∫–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω)</li>
            <li>‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω)</li>
            <li>‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–æ–≤</li>
            <li>‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</li>
        </ul>
    </div>
    {% endif %}
</div>

<script>
function changeRole(userId, newRole) {
    if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ "${newRole}"?`)) {
        // –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∏–ª–∏
        location.reload();
        return;
    }
    
    const formData = new FormData();
    formData.append('new_role', newRole);
    
    fetch(`/api/user/${userId}/change-role`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`‚úÖ ${data.message}`);
            location.reload();
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏');
        location.reload();
    });
}

function deleteUser(userId, userName) {
    if (!confirm(`–í–ù–ò–ú–ê–ù–ò–ï! –í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!\n\n–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:\n- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\n- –í—Å–µ –µ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è\n- –í—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ`)) {
        return;
    }
    
    // –î–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if (!confirm(`–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!\n\n–£–¥–∞–ª–∏—Ç—å "${userName}"?`)) {
        return;
    }
    
    fetch(`/api/user/${userId}/delete`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`‚úÖ ${data.message}`);
            location.reload();
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    });
}
</script>

{% endblock %}
