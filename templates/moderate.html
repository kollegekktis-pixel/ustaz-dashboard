{% extends "layout.html" %}

{% block title %}{{ t('moderate') }} - {{ t('app_title') }}{% endblock %}

{% block content %}
<style>
    .moderate-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .moderate-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .moderate-header h1 {
        color: white;
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .moderate-header p {
        color: rgba(255, 255, 255, 0.9);
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #7030A0;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: #666;
        font-size: 0.9rem;
    }

    .achievements-table {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th {
        background: #7030A0;
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
    }

    td {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
    }

    tr:hover {
        background: #f8f5fc;
    }

    .teacher-name {
        font-weight: 600;
        color: #7030A0;
    }

    .achievement-title {
        font-weight: 600;
        color: #333;
    }

    .achievement-details {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.25rem;
    }

    .points-badge {
        display: inline-block;
        background: linear-gradient(135deg, #7030A0 0%, #9b59d0 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
    }

    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-approved {
        background: #d4edda;
        color: #155724;
    }

    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        font-size: 0.85rem;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-approve {
        background: #4CAF50;
        color: white;
    }

    .btn-approve:hover:not(:disabled) {
        background: #45a049;
    }

    .btn-reject {
        background: #f44336;
        color: white;
    }

    .btn-reject:hover:not(:disabled) {
        background: #da190b;
    }

    .btn-view {
        background: #2196F3;
        color: white;
    }

    .btn-view:hover {
        background: #0b7dda;
    }

    .filter-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        background: white;
        padding: 1rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        flex-wrap: wrap;
    }

    .filter-tab {
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        border: 2px solid transparent;
    }

    .filter-tab.active {
        background: linear-gradient(135deg, #7030A0 0%, #9b59d0 100%);
        color: white;
    }

    .filter-tab:not(.active):hover {
        border-color: #7030A0;
        color: #7030A0;
    }

    .date-text {
        font-size: 0.85rem;
        color: #999;
    }

    .info-box {
        margin-top: 2rem;
        padding: 1.5rem;
        background: #e3f2fd;
        border-radius: 15px;
        border-left: 4px solid #2196F3;
    }

    @media (max-width: 768px) {
        .moderate-container {
            padding: 1rem;
        }

        table {
            font-size: 0.85rem;
        }

        th, td {
            padding: 0.75rem 0.5rem;
        }

        .action-buttons {
            flex-direction: column;
        }

        .filter-tabs {
            flex-wrap: wrap;
        }
    }
</style>

<div class="moderate-container">
    <div class="moderate-header">
        <h1>‚úÖ {{ t('moderate') }}</h1>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–µ–¥–∞–≥–æ–≥–æ–≤</p>
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-number">{{ achievements|length }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">
                {{ achievements|selectattr('status', 'equalto', 'pending')|list|length }}
            </div>
            <div class="stat-label">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">
                {{ achievements|selectattr('status', 'equalto', 'approved')|list|length }}
            </div>
            <div class="stat-label">–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">
                {{ achievements|selectattr('status', 'equalto', 'rejected')|list|length }}
            </div>
            <div class="stat-label">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
        </div>
    </div>

    <div class="filter-tabs">
        <div class="filter-tab active" onclick="filterByStatus('all')">–í—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
        <div class="filter-tab" onclick="filterByStatus('pending')">‚è≥ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
        <div class="filter-tab" onclick="filterByStatus('approved')">‚úÖ –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</div>
        <div class="filter-tab" onclick="filterByStatus('rejected')">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
    </div>

    <div class="achievements-table">
        <table>
            <thead>
                <tr>
                    <th>–£—á–∏—Ç–µ–ª—å</th>
                    <th>–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–ë–∞–ª–ª—ã</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="achievementsTable">
                {% if achievements %}
                    {% for ach in achievements %}
                    <tr data-status="{{ ach.status }}">
                        <td>
                            <div class="teacher-name">{{ ach.user.full_name }}</div>
                            <div class="achievement-details">{{ ach.user.school }}</div>
                        </td>
                        <td>
                            <div class="achievement-title">{{ ach.title }}</div>
                            <div class="achievement-details">
                                {{ ach.level }} —É—Ä–æ–≤–µ–Ω—å
                                {% if ach.place %} | {{ ach.place }} –º–µ—Å—Ç–æ{% endif %}
                                {% if ach.student_name %} | {{ ach.student_name }}{% endif %}
                            </div>
                        </td>
                        <td>
                            <span style="display: inline-block; background: #f0f0f0; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.85rem;">
                                {{ ach.achievement_type }}
                            </span>
                        </td>
                        <td>
                            <span class="points-badge">{{ ach.points }} –±.</span>
                        </td>
                        <td>
                            <span class="status-badge status-{{ ach.status }}">
                                {% if ach.status == 'pending' %}
                                    ‚è≥ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ
                                {% elif ach.status == 'approved' %}
                                    ‚úÖ –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
                                {% elif ach.status == 'rejected' %}
                                    ‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="date-text">{{ ach.created_at.strftime('%d.%m.%Y') }}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                {% if ach.file_path %}
                                <a href="{{ ach.file_path }}" target="_blank" class="btn btn-view">üëÅÔ∏è</a>
                                {% endif %}
                                
                                {% if ach.status == 'pending' %}
                                <button class="btn btn-approve" onclick="approveAchievement({{ ach.id }}, this)">
                                    ‚úÖ –£—Ç–≤–µ—Ä–¥–∏—Ç—å
                                </button>
                                <button class="btn btn-reject" onclick="rejectAchievement({{ ach.id }}, this)">
                                    ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                                {% elif ach.status == 'approved' %}
                                <button class="btn btn-reject" onclick="rejectAchievement({{ ach.id }}, this)">
                                    ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                                {% elif ach.status == 'rejected' %}
                                <button class="btn btn-approve" onclick="approveAchievement({{ ach.id }}, this)">
                                    ‚úÖ –£—Ç–≤–µ—Ä–¥–∏—Ç—å
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #999;">
                            –ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="info-box">
        <strong>‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è {{ t(user.role) }}:</strong>
        <ul style="margin-top: 1rem; margin-left: 1.5rem;">
            <li>–ù–∞–∂–º–∏—Ç–µ üëÅÔ∏è —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç</li>
            <li>–ù–∞–∂–º–∏—Ç–µ ‚úÖ –£—Ç–≤–µ—Ä–¥–∏—Ç—å —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ</li>
            <li>–ù–∞–∂–º–∏—Ç–µ ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º</li>
            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–æ —Å—Ç–∞—Ç—É—Å—É</li>
        </ul>
    </div>
</div>

<script>
function approveAchievement(achievementId, button) {
    if (!confirm('–£—Ç–≤–µ—Ä–¥–∏—Ç—å —ç—Ç–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ?')) return;
    
    button.disabled = true;
    button.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
    
    fetch(`/api/achievements/${achievementId}/approve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('‚úÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!');
            location.reload();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
            button.disabled = false;
            button.textContent = '‚úÖ –£—Ç–≤–µ—Ä–¥–∏—Ç—å';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏');
        button.disabled = false;
        button.textContent = '‚úÖ –£—Ç–≤–µ—Ä–¥–∏—Ç—å';
    });
}

function rejectAchievement(achievementId, button) {
    const reason = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):');
    if (reason === null) return; // –û—Ç–º–µ–Ω–µ–Ω–æ
    
    button.disabled = true;
    button.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
    
    fetch(`/api/achievements/${achievementId}/reject`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('‚ùå –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ!');
            location.reload();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
            button.disabled = false;
            button.textContent = '‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏');
        button.disabled = false;
        button.textContent = '‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å';
    });
}

function filterByStatus(status) {
    const rows = document.querySelectorAll('#achievementsTable tr[data-status]');
    const tabs = document.querySelectorAll('.filter-tab');
    
    // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏
    rows.forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}
</script>

{% endblock %}
